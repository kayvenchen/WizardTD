<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WizardTD</a> &gt; <a href="index.source.html" class="el_package">WizardTD</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package WizardTD;

import processing.core.PApplet;
import processing.core.PImage;
import processing.data.JSONArray;
import processing.data.JSONObject;
import processing.event.MouseEvent;

import java.awt.Graphics2D;
import java.awt.geom.AffineTransform;
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.IOException;
import java.util.*;

public class App extends PApplet {

    public static final int CELLSIZE = 32;
    public static final int SIDEBAR = 120;
    public static final int TOPBAR = 40;
    public static final int BOARD_WIDTH = 20;

<span class="nc" id="L23">    public static int WIDTH = CELLSIZE*BOARD_WIDTH+SIDEBAR;</span>
<span class="nc" id="L24">    public static int HEIGHT = BOARD_WIDTH*CELLSIZE+TOPBAR;</span>
    
    public static final int FPS = 60;

    public String configPath;
    public JSONObject config;

<span class="nc" id="L31">    public Random random = new Random();</span>
	
    private PImage grassImage;
    private PImage path0Image;
    private PImage path1Image;
    private PImage path2Image;
    private PImage path3Image;
    private PImage shrubImage;
    private PImage wizardHouseImage;

    private Tile wizardHouse;
    private ArrayList&lt;Tile&gt; tiles;
<span class="nc" id="L43">    private Cell[][] grid = new Cell[20][20];</span>
<span class="nc" id="L44">    private Cell hoveredCell = null;</span>

    private ArrayList&lt;Waypoint&gt; waypoints;
    private ArrayList&lt;SpawnPoint&gt; spawnPoints;

    private PImage gremlinImage;


<span class="nc" id="L52">    PImage[] towerImages = new PImage[3];</span>
    private ArrayList&lt;Tower&gt; towers;

    private Tower towerInitStats;
    
    private PImage fireballImage;
    private ArrayList&lt;Fireball&gt; fireballs;

<span class="nc" id="L60">    private boolean towerPlacementMode = false;</span>
<span class="nc" id="L61">    private boolean upgradeRange = false;</span>
<span class="nc" id="L62">    private boolean upgradeSpeed = false;</span>
<span class="nc" id="L63">    private boolean upgradeDamage = false;</span>

    private ArrayList&lt;Wave&gt; waves;
    private ArrayList&lt;Monster&gt; monsters;
    private ArrayList&lt;Monster&gt; monstersToSpawn;
<span class="nc" id="L68">    boolean allMonstersDead = false;</span>

    private int currentWaveIndex;

    private Mana wizardMana;

    private int initialMana;
    private int initialManaCap;
    private int initialManaGain;

    private int manaPoolSpellInitialCost;
    private int manaPoolSpellCostIncreasePerUse;
    private float manaPoolSpellCapMultiplier;
    private float manaPoolSpellManaGainedMultiplier;

    private int manaPoolSpellCurrentCost;
    
<span class="nc" id="L85">    private double spawnTimer = 0;</span>

<span class="nc" id="L87">    private int gameSpeedMultiplier = 1;</span>
<span class="nc" id="L88">    private boolean isPaused = false;</span>
<span class="nc" id="L89">    private boolean isFastfoward = false;</span>

<span class="nc" id="L91">    private boolean lost = false;</span>
    
<span class="nc" id="L93">    public App() {</span>
<span class="nc" id="L94">        this.configPath = &quot;config.json&quot;;</span>

<span class="nc" id="L96">        this.tiles = new ArrayList&lt;Tile&gt;();</span>

<span class="nc" id="L98">        this.waves = new ArrayList&lt;Wave&gt;();</span>
<span class="nc" id="L99">        this.monsters = new ArrayList&lt;Monster&gt;();</span>
<span class="nc" id="L100">        this.monstersToSpawn = new ArrayList&lt;Monster&gt;();</span>
<span class="nc" id="L101">        this.waypoints = new ArrayList&lt;Waypoint&gt;();</span>
<span class="nc" id="L102">        this.spawnPoints = new ArrayList&lt;SpawnPoint&gt;();</span>

<span class="nc" id="L104">        this.towers = new ArrayList&lt;Tower&gt;();</span>

<span class="nc" id="L106">        this.fireballs = new ArrayList&lt;Fireball&gt;();</span>

<span class="nc" id="L108">    }</span>

    /**
     * Initialise the setting of the window size.
     */
	@Override
    public void settings() {
<span class="nc" id="L115">        size(WIDTH, HEIGHT);</span>
<span class="nc" id="L116">    }</span>

    /**
     * Load all resources such as images. Initialise the elements such as the player, enemies and map elements.
     */
	@Override
    public void setup() {
<span class="nc" id="L123">        frameRate(FPS);</span>

<span class="nc" id="L125">        config = loadJSONObject(&quot;config.json&quot;);</span>


        // init grid
<span class="nc bnc" id="L129" title="All 2 branches missed.">        for (int y = 0; y &lt; grid.length; y++) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            for(int x = 0; x &lt; grid[0].length; x++) {</span>
<span class="nc" id="L131">                grid[x][y] = new Cell(x, y);</span>
            }
        }

        // map loading
<span class="nc" id="L136">        this.grassImage = loadImage(&quot;src/main/resources/WizardTD/grass.png&quot;);</span>
<span class="nc" id="L137">        this.path0Image = loadImage(&quot;src/main/resources/WizardTD/path0.png&quot;);</span>
<span class="nc" id="L138">        this.path1Image = loadImage(&quot;src/main/resources/WizardTD/path1.png&quot;);</span>
<span class="nc" id="L139">        this.path2Image = loadImage(&quot;src/main/resources/WizardTD/path2.png&quot;);</span>
<span class="nc" id="L140">        this.path3Image = loadImage(&quot;src/main/resources/WizardTD/path3.png&quot;);</span>
<span class="nc" id="L141">        this.shrubImage = loadImage(&quot;src/main/resources/WizardTD/shrub.png&quot;);</span>
<span class="nc" id="L142">        this.wizardHouseImage = loadImage(&quot;src/main/resources/WizardTD/wizard_house.png&quot;);</span>

<span class="nc" id="L144">        String layout = config.getString(&quot;layout&quot;);</span>
<span class="nc" id="L145">        loadMap(layout);</span>

        

        // getting wave info from config
<span class="nc" id="L150">        this.gremlinImage = loadImage(&quot;src/main/resources/WizardTD/gremlin.png&quot;);</span>
        
        
        // read config file for waves
<span class="nc" id="L154">        JSONArray configWaves = config.getJSONArray(&quot;waves&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (int i = 0; i &lt; configWaves.size(); i++) {</span>
<span class="nc" id="L156">            JSONObject configWave = configWaves.getJSONObject(i);</span>
<span class="nc" id="L157">            int duration = configWave.getInt(&quot;duration&quot;);</span>
<span class="nc" id="L158">            double preWavePause = configWave.getDouble(&quot;pre_wave_pause&quot;);</span>
<span class="nc" id="L159">            JSONArray configMonsters = configWave.getJSONArray(&quot;monsters&quot;);</span>
            // Clear the monsters list for each wave
<span class="nc" id="L161">            monsters.clear();</span>

            // monsters
<span class="nc bnc" id="L164" title="All 2 branches missed.">            for (int j = 0; j &lt; configMonsters.size(); j++) {</span>
<span class="nc" id="L165">                JSONObject configMonster = configMonsters.getJSONObject(j);</span>
<span class="nc" id="L166">                String type = configMonster.getString(&quot;type&quot;);</span>
<span class="nc" id="L167">                int hp = configMonster.getInt(&quot;hp&quot;);</span>
<span class="nc" id="L168">                double speed = configMonster.getDouble(&quot;speed&quot;);</span>
<span class="nc" id="L169">                double armour = configMonster.getDouble(&quot;armour&quot;);</span>
<span class="nc" id="L170">                int mana_gained_on_kill = configMonster.getInt(&quot;mana_gained_on_kill&quot;);</span>
<span class="nc" id="L171">                int quantity = configMonster.getInt(&quot;quantity&quot;);</span>
                // get death frames
                
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (type.equals(&quot;gremlin&quot;)) {</span>
<span class="nc" id="L175">                    monsters.add(new Monster(gremlinImage, hp, speed, armour, mana_gained_on_kill, wizardHouse));</span>
                    }
                
<span class="nc" id="L178">                waves.add(new Wave(preWavePause, duration, monsters, quantity));</span>
            }

            // tower loading 
<span class="nc" id="L182">            towerImages[0] = loadImage(&quot;src/main/resources/WizardTD/tower0.png&quot;);</span>
<span class="nc" id="L183">            towerImages[1] = loadImage(&quot;src/main/resources/WizardTD/tower1.png&quot;);</span>
<span class="nc" id="L184">            towerImages[2] = loadImage(&quot;src/main/resources/WizardTD/tower2.png&quot;);</span>
            
<span class="nc" id="L186">            int towerCost = config.getInt(&quot;tower_cost&quot;);</span>
<span class="nc" id="L187">            int initialTowerRange = config.getInt(&quot;initial_tower_range&quot;);</span>
<span class="nc" id="L188">            double initialTowerFiringSpeed = config.getDouble(&quot;initial_tower_firing_speed&quot;);</span>
<span class="nc" id="L189">            int initialTowerDamage = config.getInt(&quot;initial_tower_damage&quot;);</span>

<span class="nc" id="L191">            towerInitStats = new Tower(towerImages, towerCost, initialTowerRange, initialTowerFiringSpeed, initialTowerDamage);</span>

<span class="nc" id="L193">            this.fireballImage = loadImage(&quot;src/main/resources/WizardTD/fireball.png&quot;);</span>
            
<span class="nc bnc" id="L195" title="All 2 branches missed.">            for (int m = 0; m &lt; 100; m++) {</span>
<span class="nc" id="L196">                Fireball fireball = new Fireball(fireballImage);</span>
<span class="nc" id="L197">                fireballs.add(fireball);</span>
            }

<span class="nc" id="L200">            initialMana = config.getInt(&quot;initial_mana&quot;);</span>
<span class="nc" id="L201">            initialManaCap = config.getInt(&quot;initial_mana_cap&quot;);</span>
<span class="nc" id="L202">            initialManaGain = config.getInt(&quot;initial_mana_gained_per_second&quot;);</span>

<span class="nc" id="L204">            manaPoolSpellInitialCost = config.getInt(&quot;mana_pool_spell_initial_cost&quot;);</span>
<span class="nc" id="L205">            manaPoolSpellCurrentCost = manaPoolSpellInitialCost;</span>
<span class="nc" id="L206">            manaPoolSpellCostIncreasePerUse =  config.getInt(&quot;mana_pool_spell_cost_increase_per_use&quot;);</span>
<span class="nc" id="L207">            manaPoolSpellCapMultiplier = config.getFloat(&quot;mana_pool_spell_cap_multiplier&quot;);</span>
<span class="nc" id="L208">            manaPoolSpellManaGainedMultiplier = config.getFloat(&quot;mana_pool_spell_mana_gained_multiplier&quot;);</span>

<span class="nc" id="L210">            wizardMana = new Mana(initialMana, initialManaCap, initialManaGain);</span>
        }
        
        
<span class="nc" id="L214">    }</span>

    /**
     * check location mouse
     */
    public void mouseCheck() {
<span class="nc" id="L220">        int gridX = (int) (mouseX / CELLSIZE);</span>
<span class="nc" id="L221">        int gridY = (int) ((mouseY-TOPBAR) / CELLSIZE);</span>

<span class="nc bnc" id="L223" title="All 8 branches missed.">        if (gridX &gt;= 0 &amp;&amp; gridX &lt; BOARD_WIDTH &amp;&amp; gridY &gt;= 0 &amp;&amp; gridY &lt; BOARD_WIDTH) {</span>
<span class="nc" id="L224">            hoveredCell = grid[gridX][gridY];</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (hoveredCell.getOccupant() != null) {</span>
<span class="nc" id="L226">                noFill();</span>
<span class="nc" id="L227">                strokeWeight(2);</span>
<span class="nc" id="L228">                stroke(232, 219, 120);</span>
<span class="nc" id="L229">                ellipse(hoveredCell.getX() * CELLSIZE + CELLSIZE/2, hoveredCell.getY() * CELLSIZE + TOPBAR + CELLSIZE/2, hoveredCell.getOccupant().getRange()*2, hoveredCell.getOccupant().getRange()*2);</span>
<span class="nc bnc" id="L230" title="All 6 branches missed.">                if (upgradeRange || upgradeSpeed || upgradeDamage) {</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    int rangeCost = upgradeRange ? hoveredCell.getOccupant().getUpgradeCost(hoveredCell.getOccupant().getRangeLevel()) : 0;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">                    int speedCost = upgradeSpeed ? hoveredCell.getOccupant().getUpgradeCost(hoveredCell.getOccupant().getSpeedLevel()) : 0;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                    int damageCost = upgradeDamage ? hoveredCell.getOccupant().getUpgradeCost(hoveredCell.getOccupant().getDamageLevel()) : 0;</span>
<span class="nc" id="L234">                    displayUpgradeCost(rangeCost, speedCost, damageCost);</span>
                }
            }
        }
<span class="nc" id="L238">    }</span>

    /**
     * Receive key pressed signal from the keyboard.
     */
	@Override
    public void keyPressed(){
<span class="nc bnc" id="L245" title="All 4 branches missed.">        if (key == 'f' || key == 'F') {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            gameSpeedMultiplier = (gameSpeedMultiplier == 1) ? 2 : 1;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            isFastfoward = !isFastfoward;</span>
<span class="nc bnc" id="L248" title="All 4 branches missed.">        } else if (key == 'p' || key == 'P') {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            isPaused = !isPaused;</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">        } else if (key == 't' || key == 'T') {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            towerPlacementMode = !towerPlacementMode; </span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">        } else if (key == '1') {</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">            upgradeRange = !upgradeRange;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        } else if (key == '2') {</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">            upgradeSpeed = !upgradeSpeed;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">        } else if (key == '3') {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            upgradeDamage = !upgradeDamage;</span>
<span class="nc bnc" id="L258" title="All 4 branches missed.">        } else if (key == 'm' || key == 'M') {</span>
<span class="nc" id="L259">            wizardMana.useManaPoolSpell(manaPoolSpellCurrentCost, manaPoolSpellCapMultiplier, manaPoolSpellManaGainedMultiplier);</span>
<span class="nc" id="L260">            manaPoolSpellCurrentCost *= manaPoolSpellCostIncreasePerUse;</span>
<span class="nc bnc" id="L261" title="All 4 branches missed.">        } else if (key == 'r' || key == 'R') {</span>
<span class="nc" id="L262">            resetGame();</span>
<span class="nc" id="L263">            loop();</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">        }  else if (key == 's' || key == 'S') {</span>
<span class="nc" id="L265">            startNextWave();</span>
        }
<span class="nc" id="L267">    }</span>

    public void resetGame() {
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (lost) {</span>
<span class="nc" id="L271">            currentWaveIndex = 0;</span>
<span class="nc" id="L272">            wizardMana.setCurrentMana(initialMana);</span>
<span class="nc" id="L273">            manaPoolSpellCurrentCost = manaPoolSpellInitialCost;</span>
<span class="nc" id="L274">            monstersToSpawn.clear();</span>
<span class="nc" id="L275">            lost = false;</span>
<span class="nc" id="L276">            loop();</span>
        }
<span class="nc" id="L278">    }</span>

    public Fireball getAvailableFireball() {
<span class="nc bnc" id="L281" title="All 2 branches missed.">        for (Fireball fireball : fireballs) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (!fireball.isFiring()) {</span>
<span class="nc" id="L283">                return fireball; // Return the first available fireball</span>
            }
<span class="nc" id="L285">        }</span>
<span class="nc" id="L286">        return null; // If all fireballs in the pool are in use, return null</span>
    }

    /**
     * Receive key released signal from the keyboard.
     */
	@Override
    public void keyReleased(){

<span class="nc" id="L295">    }</span>

    @Override
    public void mousePressed(MouseEvent e) {
        // tower placement
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (towerPlacementMode) {</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (hoveredCell != null) {</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                if (hoveredCell.getBuildable()) {</span>
<span class="nc" id="L303">                    wizardMana.decreaseMana(100);</span>
<span class="nc" id="L304">                    hoveredCell.buildTower(new Tower(towerInitStats, hoveredCell.getX(), hoveredCell.getY()), towers);</span>
                }
            }
        // if not in tower placement mode we have to check if there is a tower at hovered square
        }
<span class="nc" id="L309">        Tower towerToUpgrade = hoveredCell.getOccupant();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (towerToUpgrade != null) {</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">            if (upgradeRange &amp;&amp; wizardMana.getCurrentMana() &gt;= towerToUpgrade.getUpgradeCost(towerToUpgrade.getRangeLevel())) {</span>
<span class="nc" id="L312">                wizardMana.decreaseMana(towerToUpgrade.getUpgradeCost(towerToUpgrade.getRangeLevel()));</span>
<span class="nc" id="L313">                hoveredCell.getOccupant().upgradeRange();</span>
            } 
<span class="nc bnc" id="L315" title="All 4 branches missed.">            if (upgradeSpeed &amp;&amp; wizardMana.getCurrentMana() &gt;= towerToUpgrade.getUpgradeCost(towerToUpgrade.getSpeedLevel())) {</span>
<span class="nc" id="L316">                wizardMana.decreaseMana(towerToUpgrade.getUpgradeCost(towerToUpgrade.getSpeedLevel()));</span>
<span class="nc" id="L317">                hoveredCell.getOccupant().upgradeSpeed();</span>
            }
<span class="nc bnc" id="L319" title="All 4 branches missed.">            if (upgradeDamage &amp;&amp; wizardMana.getCurrentMana() &gt;= towerToUpgrade.getUpgradeCost(towerToUpgrade.getDamageLevel())) {</span>
<span class="nc" id="L320">                wizardMana.decreaseMana(towerToUpgrade.getUpgradeCost(towerToUpgrade.getDamageLevel()));</span>
<span class="nc" id="L321">                hoveredCell.getOccupant().upgradeDamage();</span>
            }
        }
<span class="nc" id="L324">    }</span>

    @Override
    public void mouseReleased(MouseEvent e) {

<span class="nc" id="L329">    }</span>

    /*@Override
    public void mouseDragged(MouseEvent e) {

    }*/

    /**
     * Draw all elements in the game by current frame.
     */
	@Override
    public void draw() {
<span class="nc bnc" id="L341" title="All 2 branches missed.">        for (int i = 0; i &lt; gameSpeedMultiplier; i++) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (!isPaused) {</span>
<span class="nc" id="L343">                spawnMonster();</span>
<span class="nc" id="L344">                allMonstersDead = checkAllMonstersDead();</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">                if (allMonstersDead) {</span>

<span class="nc" id="L348">                    startNextWave();</span>
                }        

<span class="nc bnc" id="L351" title="All 2 branches missed.">                for (Monster monster : monstersToSpawn) {</span>
<span class="nc" id="L352">                    monster.tick();</span>
<span class="nc" id="L353">                }</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">                for (Fireball fireball : fireballs) {</span>
<span class="nc" id="L356">                    fireball.tick();</span>
<span class="nc" id="L357">                }</span>
                
<span class="nc bnc" id="L359" title="All 2 branches missed.">                for (Tower tower : towers) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                    for (Monster monster : monstersToSpawn) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                        if (monster.isAlive()) {</span>
<span class="nc" id="L362">                            long currentTime = System.currentTimeMillis();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">                            if (currentTime - tower.getLastFireTime() &gt;= tower.getFireInterval()) {</span>
                                // monster offsets
<span class="nc" id="L365">                                float monsterXOffset = monster.getX()*CELLSIZE + 5 + monster.getWidth()/2;</span>
<span class="nc" id="L366">                                float monsterYOffset = monster.getY()*CELLSIZE + TOPBAR + 5 + monster.getHeight()/2;</span>
                                // tower offsets
<span class="nc" id="L368">                                int towerXOffset = tower.getX() * CELLSIZE + CELLSIZE/2;</span>
<span class="nc" id="L369">                                int towerYOffset = tower.getY() * CELLSIZE + CELLSIZE/2 + TOPBAR;</span>

<span class="nc" id="L371">                                float distance = dist(towerXOffset, towerYOffset, monsterXOffset, monsterYOffset);</span>
<span class="nc" id="L372">                                double direction = Math.atan2(monsterYOffset - towerYOffset, monsterXOffset - towerXOffset);</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">                                if (distance &lt;= tower.getRange()) {</span>
<span class="nc" id="L375">                                    Fireball newFireball = getAvailableFireball();</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                                    if (newFireball != null) {</span>
<span class="nc" id="L377">                                        newFireball.setStartLocation(towerXOffset, towerYOffset, direction, tower.getDamage(), tower.getRange());</span>
<span class="nc" id="L378">                                        tower.setLastFireTime(currentTime);</span>
                                    }
                                } 
                            }
                        }
<span class="nc" id="L383">                    }</span>
<span class="nc" id="L384">                }</span>
            // increase mana over time
<span class="nc" id="L386">            wizardMana.increaseManaOverTime();    </span>
            }     

<span class="nc bnc" id="L389" title="All 2 branches missed.">            for (Tile tile : tiles) {</span>
<span class="nc" id="L390">                    image(tile.getTile(), (tile.getX() * CELLSIZE), tile.getY() * CELLSIZE + TOPBAR); </span>
<span class="nc" id="L391">                }</span>
<span class="nc" id="L392">                image(this.wizardHouse.getTile(), this.wizardHouse.getX() * 32 - 8, this.wizardHouse.getY() * CELLSIZE + TOPBAR - 8);</span>
            
<span class="nc bnc" id="L394" title="All 2 branches missed.">            for (Monster monster : monstersToSpawn) {</span>
<span class="nc" id="L395">                monster.draw(this);</span>
<span class="nc" id="L396">            }</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">            for (Tower tower : towers) {</span>
<span class="nc" id="L399">                tower.draw(this);</span>
<span class="nc" id="L400">            }</span>
            
<span class="nc bnc" id="L402" title="All 2 branches missed.">            for (Fireball fireball : fireballs) {</span>
<span class="nc" id="L403">                fireball.draw(this);</span>
<span class="nc" id="L404">            }</span>
            
            // topbar and sidebar
<span class="nc" id="L407">            fill(129, 116, 79);</span>
<span class="nc" id="L408">            noStroke();</span>
<span class="nc" id="L409">            rect(0, 0, width, TOPBAR);</span>
<span class="nc" id="L410">            rect(BOARD_WIDTH*CELLSIZE, TOPBAR, SIDEBAR,height - TOPBAR);</span>

<span class="nc" id="L412">            fill(0);  // Fill color (black)</span>
<span class="nc" id="L413">            textSize(24); // Text size</span>
<span class="nc" id="L414">            text(&quot;Wave &quot; + getCurrentWaveNumber(), 0, 32);</span>
            
            // mana bar
<span class="nc" id="L417">            wizardMana.displayManaBar(this);</span>
            // draw text to show how to use the functions

<span class="nc" id="L420">            fill(0);</span>
<span class="nc" id="L421">            textSize(12);</span>
<span class="nc" id="L422">            text(&quot;2x speed\nkey: f\nstatus: &quot; + isFastfoward + </span>
                &quot;\n\npause\nkey: p\nstatus: &quot; + isPaused + 
                &quot;\n\nbuild tower\nkey: t\ncost: 100\nstatus: &quot; + towerPlacementMode +
                &quot;\n\nupgrade range\nkey: 1\nstatus: &quot; + upgradeRange + 
                &quot;\n\nupgrade speed\nkey: 2\nstatus: &quot; + upgradeSpeed +
                &quot;\n\nupgrade damage\nkey: 3\nstatus: &quot; + upgradeDamage +
                &quot;\n\nmana pool spell\nkey: m\ncost: &quot;+ manaPoolSpellCurrentCost,
                WIDTH - SIDEBAR, TOPBAR + 20);
                     
<span class="nc" id="L431">            mouseCheck();</span>
<span class="nc" id="L432">            LoseCheck();</span>
<span class="nc" id="L433">            winCheck();</span>
        }
<span class="nc" id="L435">    }</span>


    public void winCheck() {
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (currentWaveIndex &gt; waves.size()-1) {</span>
            // You win
<span class="nc" id="L441">            background(0, 255, 0);</span>
<span class="nc" id="L442">            textSize(32);</span>
<span class="nc" id="L443">            text(&quot;YOU WIN&quot;, width/2 - 100, height/2);</span>
<span class="nc" id="L444">            noLoop();</span>
        }
<span class="nc" id="L446">    }</span>

    public void LoseCheck() {
<span class="nc bnc" id="L449" title="All 2 branches missed.">        for (Monster monster : monstersToSpawn) {</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            if (monster.getIsBanished()) {</span>
<span class="nc" id="L451">                int randomIndex = random.nextInt(spawnPoints.size());</span>
<span class="nc" id="L452">                SpawnPoint randomSpawnPoint = spawnPoints.get(randomIndex);</span>
<span class="nc" id="L453">                monster.setBanishedMonsterLocation(randomSpawnPoint.getX(), randomSpawnPoint.getY(), randomSpawnPoint.getDirection());</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                if (monster.getHp() &gt; wizardMana.getCurrentMana()) {</span>
<span class="nc" id="L455">                    background(255, 0, 0);</span>
<span class="nc" id="L456">                    textSize(32);</span>
<span class="nc" id="L457">                    text(&quot;YOU LOST&quot;, WIDTH/2 - 100, HEIGHT/2);</span>
<span class="nc" id="L458">                    text(&quot;Press 'r' to restart&quot;, WIDTH/2 - 150, HEIGHT/2 + 50);</span>
<span class="nc" id="L459">                    lost = true;</span>
<span class="nc" id="L460">                    noLoop();</span>
                } else {
<span class="nc" id="L462">                    wizardMana.decreaseMana(monster.getHp());</span>
                }
            }
<span class="nc" id="L465">        }</span>
<span class="nc" id="L466">    }</span>

    public int getCurrentWaveNumber() {
<span class="nc" id="L469">        return currentWaveIndex + 1;</span>
    }

    public void spawnMonster() {
<span class="nc" id="L473">        this.spawnTimer--;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (this.spawnTimer &lt; 0) {</span>
<span class="nc" id="L475">            int randomIndex = random.nextInt(spawnPoints.size());</span>
<span class="nc" id="L476">            SpawnPoint randomSpawnPoint = spawnPoints.get(randomIndex);</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">            if (monstersToSpawn.size() &lt; getCurrentWave().getQuantity()) {</span>
<span class="nc" id="L478">                Monster monsterType = getCurrentWave().getMonstersToSpawn().get(0);</span>
<span class="nc" id="L479">                monstersToSpawn.add(new Monster(monsterType, randomSpawnPoint.getX(), randomSpawnPoint.getY(), randomSpawnPoint.getDirection(), waypoints, fireballs));</span>
            }
<span class="nc" id="L481">            this.spawnTimer = 120;</span>
        }
<span class="nc" id="L483">    }</span>

    public boolean checkAllMonstersDead() {
        // Loop through list of monsters and check if they are all dead
<span class="nc bnc" id="L487" title="All 2 branches missed.">        if (monstersToSpawn.size() &lt; getCurrentWave().getQuantity()) {</span>
<span class="nc" id="L488">            return false;</span>
        }
<span class="nc bnc" id="L490" title="All 2 branches missed.">        for (Monster monster : monstersToSpawn) {</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">            if (monster.isAlive()) {</span>
<span class="nc" id="L492">                return false; // If at least one monster is still alive, return false</span>
            }
<span class="nc" id="L494">        }</span>
<span class="nc" id="L495">        return true; // All monsters are dead</span>
    }

    public Wave getCurrentWave() {
<span class="nc bnc" id="L499" title="All 4 branches missed.">        if (currentWaveIndex &gt;= 0 &amp;&amp; currentWaveIndex &lt; waves.size()) {</span>
<span class="nc" id="L500">            return waves.get(currentWaveIndex);</span>
        }
<span class="nc" id="L502">        return null;</span>
    }

    public void startNextWave() {
<span class="nc" id="L506">        currentWaveIndex++;</span>
<span class="nc" id="L507">        monstersToSpawn.clear();</span>
<span class="nc" id="L508">    }</span>
    
    public void displayUpgradeCost(int rangeCost, int speedCost, int damageCost) {
        // Display the upgrade costs at the bottom right of the screen
<span class="nc" id="L512">        fill(255);</span>
<span class="nc" id="L513">        stroke(0);</span>
<span class="nc" id="L514">        rect(WIDTH - SIDEBAR, HEIGHT - 100, 200, 100);</span>
    
<span class="nc" id="L516">        fill(0); // Text color</span>
<span class="nc" id="L517">        textSize(12);</span>
    
<span class="nc" id="L519">        text(&quot;Range Cost: &quot; + rangeCost, WIDTH - SIDEBAR + 5, HEIGHT - 80);</span>
<span class="nc" id="L520">        text(&quot;Speed Cost: &quot; + speedCost, WIDTH - SIDEBAR + 5, HEIGHT - 60);</span>
<span class="nc" id="L521">        text(&quot;Damage Cost: &quot; + damageCost, WIDTH - SIDEBAR+  5, HEIGHT - 40);</span>
    
<span class="nc" id="L523">        int totalCost = rangeCost + speedCost + damageCost;</span>
<span class="nc" id="L524">        text(&quot;Total Cost: &quot; + totalCost, WIDTH - SIDEBAR + 5, HEIGHT - 20);</span>
<span class="nc" id="L525">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L528">        PApplet.main(&quot;WizardTD.App&quot;);</span>
<span class="nc" id="L529">    }</span>

    /**
     * loads map by reading the txt files and placing tiles based of of the letter in the row
     * only works for files that have 20 lines
     * @param filename the path to the level file you want to load.
     */
    public void loadMap(String filename) {
<span class="nc" id="L537">        try (BufferedReader br = createReader(filename)) {</span>
<span class="nc" id="L538">            HashSet&lt;Character&gt; pathChars = new HashSet&lt;&gt;(Arrays.asList('X', 'U', 'D', 'L', 'R'));</span>
<span class="nc" id="L539">            HashSet&lt;Character&gt; waypointChars = new HashSet&lt;&gt;(Arrays.asList('U', 'D', 'L', 'R'));</span>
<span class="nc" id="L540">            String[] lines = new String[20];</span>
<span class="nc" id="L541">            int y = 0;</span>
    
            // Read the map layout into an array of strings
            String line;
<span class="nc bnc" id="L545" title="All 2 branches missed.">            while ((line = br.readLine()) != null) {</span>
<span class="nc" id="L546">                lines[y] = line;</span>
<span class="nc" id="L547">                y++;</span>
            }
    
            // Process the map layout to determine the appropriate path types
<span class="nc bnc" id="L551" title="All 2 branches missed.">            for (y = 0; y &lt; lines.length; y++) {</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                for (int x = 0; x &lt; lines[y].length(); x++) {</span>
<span class="nc" id="L553">                    char charAtXY = lines[y].charAt(x);</span>

                    // get waypoints
<span class="nc bnc" id="L556" title="All 2 branches missed.">                    if (waypointChars.contains(charAtXY)) {</span>
<span class="nc" id="L557">                        waypoints.add(new Waypoint(charAtXY, x, y));</span>
                    }

                    // get spawnpoints paths at the edges of the map
<span class="nc bnc" id="L561" title="All 4 branches missed.">                    if (pathChars.contains(charAtXY) &amp;&amp; x == 0) {</span>
<span class="nc" id="L562">                        spawnPoints.add(new SpawnPoint(x, y, 0));</span>
<span class="nc bnc" id="L563" title="All 4 branches missed.">                    } else if (pathChars.contains(charAtXY) &amp;&amp; x == 20) {</span>
<span class="nc" id="L564">                        spawnPoints.add(new SpawnPoint(x, y, 180));</span>
<span class="nc bnc" id="L565" title="All 4 branches missed.">                    } else if (pathChars.contains(charAtXY) &amp;&amp; y == 0) {</span>
<span class="nc" id="L566">                        spawnPoints.add(new SpawnPoint(x, y, 90));</span>
<span class="nc bnc" id="L567" title="All 4 branches missed.">                    } else if (pathChars.contains(charAtXY) &amp;&amp; y == 20) {</span>
<span class="nc" id="L568">                        spawnPoints.add(new SpawnPoint(x, y, 270));</span>
                    }

                    // tiles which do not need to be rotated
<span class="nc bnc" id="L572" title="All 2 branches missed.">                    if (charAtXY == 'S') {</span>
<span class="nc" id="L573">                        tiles.add(new Tile(x, y, shrubImage));</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">                    } else if (charAtXY == ' ') {</span>
<span class="nc" id="L575">                        tiles.add(new Tile(x, y, grassImage));</span>
<span class="nc" id="L576">                        grid[x][y].setBuildable(true);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                    } else if (charAtXY == 'W') {</span>
<span class="nc" id="L578">                        tiles.add(new Tile(x, y, grassImage));</span>
<span class="nc" id="L579">                        this.wizardHouse = new Tile(x, y, wizardHouseImage);</span>
                    }
                    // check which path is appropriate and what it needs to be rotated by.
<span class="nc bnc" id="L582" title="All 2 branches missed.">                    else if (pathChars.contains(charAtXY)) {</span>
                        // check surrounding tiles
<span class="nc bnc" id="L584" title="All 4 branches missed.">                        boolean isUp = (y &gt; 0 &amp;&amp; pathChars.contains(lines[y - 1].charAt(x)));</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">                        boolean isDown = (y &lt; lines.length - 1 &amp;&amp; pathChars.contains(lines[y + 1].charAt(x)));</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">                        boolean isLeft = (x &gt; 0 &amp;&amp; pathChars.contains(lines[y].charAt(x - 1)));</span>
<span class="nc bnc" id="L587" title="All 4 branches missed.">                        boolean isRight = (x &lt; lines[y].length() - 1 &amp;&amp; pathChars.contains(lines[y].charAt(x + 1)));</span>

<span class="nc bnc" id="L589" title="All 8 branches missed.">                        if (isUp &amp;&amp; isDown &amp;&amp; isLeft &amp;&amp; isRight) {</span>
<span class="nc" id="L590">                            tiles.add(new Tile(x, y, path3Image)); // default 4-way intersection</span>
                        
<span class="nc bnc" id="L592" title="All 6 branches missed.">                        }else if (isLeft &amp;&amp; isRight &amp;&amp; isDown) {</span>
<span class="nc" id="L593">                            tiles.add(new Tile(x, y, path2Image)); // default 3-way intersection</span>
                        
<span class="nc bnc" id="L595" title="All 6 branches missed.">                        }else if (isLeft &amp;&amp; isUp &amp;&amp; isDown) {</span>
<span class="nc" id="L596">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path2Image, 90))); // 3-way rotate 90 deg</span>
<span class="nc bnc" id="L597" title="All 6 branches missed.">                        }else if (isLeft &amp;&amp; isRight &amp;&amp; isUp) {</span>
<span class="nc" id="L598">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path2Image, 180))); // 3-way rotate 180 deg</span>
<span class="nc bnc" id="L599" title="All 6 branches missed.">                        }else if (isRight &amp;&amp; isUp &amp;&amp; isDown) {</span>
<span class="nc" id="L600">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path2Image, 270))); // 3-way rotate 270 deg</span>
                            
<span class="nc bnc" id="L602" title="All 4 branches missed.">                        } else if (isLeft &amp;&amp; isDown) { </span>
<span class="nc" id="L603">                            tiles.add(new Tile(x, y, path1Image)); // default corner</span>
                        
<span class="nc bnc" id="L605" title="All 4 branches missed.">                        } else if (isLeft &amp;&amp; isUp) { </span>
<span class="nc" id="L606">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path1Image, 90))); // corner rotate 90 deg</span>
                        
<span class="nc bnc" id="L608" title="All 4 branches missed.">                        } else if (isRight &amp;&amp; isUp) { </span>
<span class="nc" id="L609">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path1Image, 180))); // default corner 180 deg</span>
                        
<span class="nc bnc" id="L611" title="All 4 branches missed.">                        } else if (isRight &amp;&amp; isDown) { </span>
<span class="nc" id="L612">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path1Image, 270))); // default corner 270 deg</span>
                        
                            
<span class="nc bnc" id="L615" title="All 4 branches missed.">                        } else if (isUp || isDown) { </span>
<span class="nc" id="L616">                            tiles.add(new Tile(x, y, rotateImageByDegrees(path0Image, 90))); // vertical straight</span>
                        }
                        
                        else {
<span class="nc" id="L620">                            tiles.add(new Tile(x, y, path0Image)); // horizontal straight</span>
                        }
                        
                    }
                }
            }
<span class="nc" id="L626">        } catch (IOException e) {</span>
<span class="nc" id="L627">            e.printStackTrace();</span>
<span class="nc" id="L628">        }</span>
<span class="nc" id="L629">    }</span>

    /**
     * Source: https://stackoverflow.com/questions/37758061/rotate-a-buffered-image-in-java
     * @param pimg The image to be rotated
     * @param angle between 0 and 360 degrees
     * @return the new rotated image
     */
    public PImage rotateImageByDegrees(PImage pimg, double angle) {
<span class="nc" id="L638">        BufferedImage img = (BufferedImage) pimg.getNative();</span>
<span class="nc" id="L639">        double rads = Math.toRadians(angle);</span>
<span class="nc" id="L640">        double sin = Math.abs(Math.sin(rads)), cos = Math.abs(Math.cos(rads));</span>
<span class="nc" id="L641">        int w = img.getWidth();</span>
<span class="nc" id="L642">        int h = img.getHeight();</span>
<span class="nc" id="L643">        int newWidth = (int) Math.floor(w * cos + h * sin);</span>
<span class="nc" id="L644">        int newHeight = (int) Math.floor(h * cos + w * sin);</span>

<span class="nc" id="L646">        PImage result = this.createImage(newWidth, newHeight, RGB);</span>
        //BufferedImage rotated = new BufferedImage(newWidth, newHeight, BufferedImage.TYPE_INT_ARGB);
<span class="nc" id="L648">        BufferedImage rotated = (BufferedImage) result.getNative();</span>
<span class="nc" id="L649">        Graphics2D g2d = rotated.createGraphics();</span>
<span class="nc" id="L650">        AffineTransform at = new AffineTransform();</span>
<span class="nc" id="L651">        at.translate((newWidth - w) / 2, (newHeight - h) / 2);</span>

<span class="nc" id="L653">        int x = w / 2;</span>
<span class="nc" id="L654">        int y = h / 2;</span>

<span class="nc" id="L656">        at.rotate(rads, x, y);</span>
<span class="nc" id="L657">        g2d.setTransform(at);</span>
<span class="nc" id="L658">        g2d.drawImage(img, 0, 0, null);</span>
<span class="nc" id="L659">        g2d.dispose();</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">        for (int i = 0; i &lt; newWidth; i++) {</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">            for (int j = 0; j &lt; newHeight; j++) {</span>
<span class="nc" id="L662">                result.set(i, j, rotated.getRGB(i, j));</span>
            }
        }

<span class="nc" id="L666">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>